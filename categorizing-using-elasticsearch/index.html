<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Categorizing using Elasticsearch</title>
    <meta name="description" content="I'm fortunate to work at a company that once a month have a 'hack day' where we are are allowed to think 'out-of-the' box and try out new ideas. As an advocate of using search for so much more than just the 'search page' I decided to do a small demo of how to use Elasticsearch to do categorization and I wanted to share some of my ideas....">
    <meta name="author" content="Henrik Lindström">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <script language="javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
    <link href="/assets/twitter/stylesheets/bootstrap.min.css?0.3169452464916118" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/font-awesome.css?0.010806214666622793" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/jquery.tweet.css?0.4415517918594535" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/style.css?0.09875811152935421" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/widgets/google_prettify/stylesheets/twitter-bootstrap.css?0.6809594350370546" type="text/css" rel="stylesheet" media="all">

<script src="/assets/twitter/javascripts/jquery.tweet.js?0.2813728351787448"></script>
 

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/"><i class="icon-search"></i>&nbsp;a life in search</a>
          <ul class="nav">
              
                <li><a href="/archive">Archive</a></li>
              
                <li><a href="/tags">Tags</a></li>
              
                <li><a href="/categories">Categories</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        <div class="page-header">
  <h1>Categorizing using Elasticsearch </h1>
</div>

<div class="row">
  <div class="span8">
    <p><span>I&#39;m fortunate to work at a company that once a month have a &#39;hack day&#39; when we are allowed to just try out new and crazy ideas. As an advocate of using search for so much more than just the &#39;search page&#39; I decided to do a small demo of how to use Elasticsearch to do categorization and I wanted to share some of my ideas.</span></p>

<h2>The approach</h2>

<p><span>We often have a large amount of data that we know falls into different categories and that we can use as a sample space for predicting unseen data. If we index all this data that we have and look at the unseen data as &#39;queries&#39; we should be able to construct queries where the score when querying the known data space represent a similarity between the &#39;objects&#39;. However, now that we have a result where each &#39;object&#39; in the result has a similarity score with the &#39;queried&#39; object how should we interpret it? What if we group all items in the results by each category that we know that they fall into and then calculate the avg similarity score within that group and return the category for which the avg score is the highest? Depending on your data and problem space constructing the similarity query might be more or less easy but the beauty of this approach is that is very easy to implement in Elasticsearch using parent-child mappings.</span></p>

<h2>Demo: Implementing a language categorizer</h2>

<p><span>We start by creating an index (I&#39;ve named it &#39;myindex&#39;) and add a parent mapping between a category type and a data type:</span></p>

<pre>
http://localhost:9200/myindex
{
    "mappings": {
        "data": {
            "_parent": {
                "type": "category"
            }
        }
    }
}
</pre>

<p><span>Then we add the known categories:</span></p>

<pre>
http://localhost:9200/myindex/category/sv
{
    "name": "Swedish"
}
...
</pre>

<p><span>For the &#39;known&#39; data we index it and relate it to the parent category:</span></p>

<pre>
http://localhost:9200/myindex/data/1?parent=sv
{
    "text": "det här är en text skriven på svenska"
}
...
</pre>

<p><span>Using the has_child-query we can then easily achieve the described approach of searching for categories and have them returned based on the avg score of a child-query issued on the data. (In this case we just do a simple query_string-query with the text we want do do language detection for, &#39;en svensk text&#39;):</span></p>

<pre>
http://localhost:9200/myindex/category/_search
{
  "query":{
    "has_child": {
      "type": "item",
      "score_type" : "avg",
      "query" : {
        "query_string": {
          "query": "en svensk text"
        }
      }
    }
  }
}
</pre>

<p><span>Resulting in:</span></p>

<pre>
{
    "took": 27,
    "timed_out": false,
    "_shards": {
        "total": 5,
        "successful": 5,
        "failed": 0
    },
    "hits": {
        "total": 1,
        "max_score": 0.3125,
        "hits": [
            {
                "_index": "myindex",
                "_type": "category",
                "_id": "sv",
                "_score": 0.3125,
                "_source": {
                    "name": "Swedish"
                }
            }
        ]
    }
}
</pre>

<p><span>Voila! In just 4 steps you know have your very own language detector.</span></p>

<h2>Discussion</h2>

<p><span>The described language detector might be a bit simplistic but can easily be more advanced by adding more advanced analyzers for your indexed data using stemmers or alike for the appropriate language. However the approach can be tweaked to do much more advanced queries on more complex objects using all the fancy query types available in Elasticsearch (just ignore the ConstantScore-query ;-)). Only your imagination stops you from creating appropriate similarity queries that might give you really good results in just a few easy steps!</span></p>

<p><span>So stop looking at your &#39;search engine&#39; as a search page provider and see it as a great tool for not just querying but also a great source for analyzing your data!</span></p>

<h3>Note:</h3>

<p><span>The Elasticsearch0.20.x releases have a bug in the has_child-query calculating the sum and not the avg score when using the score_type=avg. I&#39;ve issued a <a href="https://github.com/elasticsearch/elasticsearch/pull/2747">pull request</a> but if you want to try it out you can clone and build from the master branch where the upgraded Lucene distribution circumvents the problem.</span></p>

    
    <div class="pagination">
      <ul>
        <ul>
            <li class="prev"><a href="/hierarchical-faceting-with-episerver-find" title="Hierarchical faceting with EPiServer Find">&larr; Previous</a></li>

            <li><a href="/archive">Archive</a></li>

            <li class="next disabled"><a>Next &rarr;</a>
        </ul>
      </ul>
    </div>
    <hr>
    <div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'alifeinsearch'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
  
  <div class="span4">
    <h4>By</h4>
    <div><span><a href="https://profiles.google.com/110888837133566849493" target="_blank" rel="me">Henrik Lindström</a></span></div>
    <br>
    <h4>Published</h4>
    <div class="date"><span>2013-03-08</span></div>
    <br>
    <h4>Categories</h4>
    <ul class="tag_box">
      <li>
        <a href="/categories#elasticsearch-ref">elasticsearch <span>2</span></a>
      </li>    </ul>
    <br>
    <h4>Tags</h4>
    <ul class="tag_box">
      <li>
        <a href="/tags#elasticsearch-ref">elasticsearch <span>3</span></a>
      </li>    </ul>
  </div>
</div>

      </div>

      <footer>
        <p>&copy; Henrik Lindström 2012 
          with help from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>, <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
          and <a href="http://fortawesome.github.com/Font-Awesome/" target="_blank">Font Awesome</a>
        </p>
      </footer>

    </div> <!-- /container -->
    
    <!-- Google Prettify -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>
<!-- end Google Prettify -->
    <script>
  var _gaq=[['_setAccount','UA-34278256-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
  </body>
</html>
