<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Adding fuzzy filtering to the EPiServer Find Fluent API</title>
    <meta name="description" content="A few days back I got a question of how to do fuzzy filtering FuzzyQueries and that the core classes in EPiServer.Find had an implementation of this query but that there wasn&#39;t a corresponding filter in either Elasticsearch or EPiServer.Find for doing this. However this is quite easily done anyway and it will enable you to do queries like...">
    <meta name="author" content="Henrik Lindström">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <script language="javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
    <link href="/assets/twitter/stylesheets/bootstrap.min.css?0.5761496791288367" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/font-awesome.css?0.5345778428185328" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/jquery.tweet.css?0.767215824300276" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/style.css?0.8568592558886465" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/widgets/google_prettify/stylesheets/twitter-bootstrap.css?0.9908459052826919" type="text/css" rel="stylesheet" media="all">

<script src="/assets/twitter/javascripts/jquery.tweet.js?0.7620263167693773"></script>
 

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <a class="brand" href="/"><i class="icon-search"></i>&nbsp;a life in search</a>
        <ul class="nav">
            
              <li><a href="/archive">Archive</a></li>
            
              <li><a href="/tags">Tags</a></li>
            
              <li><a href="/categories">Categories</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="background">
    <div class="container">

      <div class="content">
        <div class="page-header">
  <h1>Adding fuzzy filtering to the EPiServer Find Fluent API </h1>
</div>

<div class="row">
  <div class="span10">
    <p><span>A few days back I got a question of how to do fuzzy filtering on a field using the Fluent API in EPiServer.Find. Some had seen that Elasticsearch had the possibility to do <a href="http://www.elasticsearch.org/guide/reference/query-dsl/fuzzy-query.html">FuzzyQueries</a> and that the core classes in EPiServer.Find had an implementation of this query but that there wasn’t a corresponding filter in either Elasticsearch or EPiServer.Find for doing this. However this is quite easily done anyway and it will enable you to do queries like:</span></p>

<pre>
var result = SearchClient.Instance.Search&lt;MyIndexedObject&gt;()
               .Filter(x => x.Author.Fuzzy("henric"))
               .GetResult();
</pre>

<h2>Writing a QueryFilter</h2>

<p><span>In Elasticsearch there is the possibility of wrapping a query in a filter using the <a href="http://www.elasticsearch.org/guide/reference/query-dsl/query-filter.html">Query Filter</a>. The latest official release for EPiServer.Find does however not have an implementation of it so we have to start by creating a new Filter class mapping to the QueryFilter implementation in Elasticsearch. Filter classes in EPiServer.Find are simply classes implementing Filter and when passed to the Json serializer are serialized to the corresponding Elasticsearch filter. So we create a QueryFilter class implementing Filter and a Json converter for serializing it:</span></p>

<pre>
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Newtonsoft.Json;
using EPiServer.Find.Api.Querying;

namespace FuzzyFiltering
{
    [JsonConverter(typeof(QueryFilterConverter))]
    public class QueryFilter : Filter
    {
        public QueryFilter(IQuery query)
        {
            Query = query;
        }

        public IQuery Query { get; set; }

        public bool Cache { get; set; }
    }

    internal class QueryFilterConverter : JsonConverter
    {
        public override void WriteJson(JsonWriter writer, object value, JsonSerializer serializer)
        {
            var filter = (QueryFilter)value;
            if (filter.Cache)
            {
                writer.WriteStartObject();
                writer.WritePropertyName("fquery");
                writer.WriteStartObject();
                writer.WritePropertyName("query");
                serializer.Serialize(writer, filter.Query);
                writer.WritePropertyName("_cache");
                serializer.Serialize(writer, filter.Cache);
                writer.WriteEndObject();
                writer.WriteEndObject();
            }
            else
            {
                writer.WriteStartObject();
                writer.WritePropertyName("query");
                serializer.Serialize(writer, filter.Query);
                writer.WriteEndObject();
            }
        }

        public override object ReadJson(JsonReader reader, Type objectType, object existingValue, JsonSerializer serializer)
        {
            return null;
        }

        public override bool CanConvert(Type objectType)
        {
            return true;
        }
    }
}
</pre>

<p><span>Now we have the possibility to do Fuzzy filtering, or any other query filtering, by simply passing the query class to the query filter. Now it is time to extend the filter extensions to get that fluent querying that we love.</span></p>

<h2>Writing a Filter extension for strings to do fuzzy matching</h2>

<p><span>A filter extension is simply an extension of the core type that we want to extend, in our case string, and that returns a DelegateFilterBuilder. The DelegateFilterBuilder in turn is created by passing a mapping from the ‘field name’ to a filter. EPiServer.Find will automatically resolve the internal Elasticsearch field name for filters for you so all you have to do is the mapping (the filter field mappings are non tokenized so your query has to match the complete value of the field):</span></p>

<pre>
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using EPiServer.Find;
using EPiServer.Find.Api.Querying.Queries;

namespace FuzzyFiltering
{
    public static class FilterExtensions
    {
        public static DelegateFilterBuilder Fuzzy(this string value, string almost)
        {
            return new DelegateFilterBuilder(field => new QueryFilter(new FuzzyQuery(field, almost)));
        }

        public static DelegateFilterBuilder Fuzzy(this string value, string almost, double minSimilarity)
        {
            return new DelegateFilterBuilder(field => new QueryFilter(new FuzzyQuery(field, almost) { MinSimilarity = minSimilarity }));
        }
    }
}
</pre>

<p><span>Voila, now we have a Fuzzy extension that we can use in our queries.</span></p>

<h2>Wrapping it up</h2>

<p><span>Importing the QueryFilter and FilterExtensions into your workspace you are now able to do that fluent search request you always wanted:</span></p>

<pre>
var result = SearchClient.Instance.Search&lt;MyIndexedObject&gt;()
               .Filter(x => x.Author.Fuzzy("henric"))
               .GetResult();
</pre>

    
    <div class="pagination">
      <ul>
        <ul>
            <li class="prev"><a href="/debugging-elasticsearch-in-eclipse" title="Debugging Elasticsearch in Eclipse">&larr; Previous</a></li>

            <li><a href="/archive">Archive</a></li>

            <li class="next"><a href="/searching-dictionaries-with-episerver-find" title="Searching Dictionaries with EPiServer Find">Next &rarr;</a></li>
        </ul>
      </ul>
    </div>
    <hr>
    <div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'alifeinsearch'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
  
  <div class="span2">
    <h4>By</h4>
    <div><span><a href="https://profiles.google.com/110888837133566849493" target="_blank" rel="me">Henrik Lindström</a></span></div>
    <br>
    <h4>Published</h4>
    <div class="date"><span>2012-09-17</span></div>
    <br>
    <h4>Categories</h4>
    <ul class="tag_box">
      <li>
        <a href="/categories#EPiServer-ref">EPiServer <span>8</span></a>
      </li>    </ul>
    <br>
    <h4>Tags</h4>
    <ul class="tag_box">
      <li>
        <a href="/tags#EPiServer-ref">EPiServer <span>8</span></a>
      </li>      <li>
        <a href="/tags#EPiServer.Find-ref">EPiServer.Find <span>8</span></a>
      </li>    </ul>
  </div>
</div>

      </div>

      <footer>
        <p>&copy; Henrik Lindström 2012 
          with help from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>, <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
          and <a href="http://fortawesome.github.com/Font-Awesome/" target="_blank">Font Awesome</a>
        </p>
      </footer>

    </div> <!-- /container -->
    
    <!-- Google Prettify -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>
<!-- end Google Prettify -->
    <script>
  var _gaq=[['_setAccount','UA-34278256-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
  </div>
  </body>
</html>
